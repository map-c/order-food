# 🔐 Token 鉴权系统实现总结

## 实现概述

已成功为餐馆点餐系统实现了完整的基于 JWT Token 的鉴权方案，包含登录、登出、Token 刷新、路由保护等核心功能。

## 技术栈

- **JWT 库**: `jose` (Next.js 推荐的边缘运行时兼容库)
- **密码加密**: `bcryptjs`
- **表单验证**: `react-hook-form` + `zod`
- **状态管理**: React Context API
- **UI 组件**: shadcn/ui

## 核心功能

### 1. 后端实现

#### JWT 工具函数 (`lib/jwt.ts`)
- ✅ 生成 Access Token (有效期 7 天)
- ✅ 生成 Refresh Token (有效期 30 天)
- ✅ Token 验证与解码
- ✅ 从请求头提取 Token

#### 密码加密 (`lib/password.ts`)
- ✅ bcrypt 密码哈希 (10 轮加盐)
- ✅ 密码验证

#### 认证 API 路由
- ✅ `POST /api/auth/login` - 用户登录
- ✅ `POST /api/auth/logout` - 用户登出
- ✅ `POST /api/auth/refresh` - 刷新 Token
- ✅ `GET /api/auth/me` - 获取当前用户信息

#### 认证中间件 (`lib/auth-middleware.ts`)
- ✅ 请求认证验证
- ✅ 基于角色的权限控制 (RBAC)

### 2. 前端实现

#### 认证上下文 (`lib/auth-context.tsx`)
- ✅ 全局认证状态管理
- ✅ 登录/登出方法
- ✅ Token 自动存储 (localStorage)
- ✅ Token 自动刷新机制
- ✅ 初始化时从本地恢复会话

#### 登录页面 (`app/(auth)/login/page.tsx`)
- ✅ 现代化 UI 设计，与系统风格一致
- ✅ 表单验证 (邮箱格式、密码必填)
- ✅ 错误提示
- ✅ 加载状态显示
- ✅ 测试账号提示卡片

#### 路由保护
- ✅ `ProtectedRoute` 组件 - 保护需要登录的页面
- ✅ `(dashboard)` 路由组 - 所有主应用页面
- ✅ `(auth)` 路由组 - 登录页面（无需导航栏）

#### API Client 增强 (`lib/api-client.ts`)
- ✅ 自动添加 Authorization 头
- ✅ 401 自动跳转登录页
- ✅ 支持 SWR 的 fetcher 函数

#### TopNav 更新
- ✅ 显示当前登录用户信息
- ✅ 实现退出登录功能

## 数据库

### 测试用户
已通过种子脚本创建以下测试账号：

| 角色 | 邮箱 | 密码 | 说明 |
|------|------|------|------|
| 管理员 | admin@example.com | admin123 | 推荐使用此账号测试 |
| 店主 | owner@example.com | owner123 | 店主权限 |
| 员工 | staff@example.com | staff123 | 员工权限 |

## 环境变量

在 `.env` 文件中添加以下配置（已创建 `.env.example` 作为模板）：

```bash
# JWT 认证配置
JWT_SECRET="your-secret-key-change-in-production-min-32-characters"
JWT_EXPIRES_IN="7d"
REFRESH_TOKEN_EXPIRES_IN="30d"
```

## 文件结构

### 新增文件
```
lib/
  ├── jwt.ts                    # JWT 工具函数
  ├── password.ts               # 密码加密工具
  ├── auth-middleware.ts        # 认证中间件
  └── auth-context.tsx          # 认证上下文

app/
  ├── (auth)/
  │   ├── layout.tsx           # 认证页面布局
  │   └── login/
  │       └── page.tsx         # 登录页面
  ├── (dashboard)/
  │   ├── layout.tsx           # 主应用布局（带路由保护）
  │   ├── page.tsx             # 首页
  │   ├── pos/                 # 点餐收银
  │   ├── orders/              # 订单管理
  │   ├── dishes/              # 菜品管理
  │   ├── tables/              # 桌台管理
  │   ├── reports/             # 报表中心
  │   └── settings/            # 系统设置
  └── api/auth/
      ├── login/route.ts       # 登录 API
      ├── logout/route.ts      # 登出 API
      ├── refresh/route.ts     # 刷新 Token API
      └── me/route.ts          # 获取用户信息 API

components/
  └── auth/
      └── protected-route.tsx  # 路由保护组件

types/
  └── auth.ts                  # 认证相关类型定义

.env.example                   # 环境变量模板
```

### 修改文件
- `app/layout.tsx` - 添加 AuthProvider
- `lib/api-client.ts` - 添加 Token 拦截器
- `components/layout/top-nav.tsx` - 显示用户信息和登出功能
- `prisma/seed.ts` - 添加加密密码的测试用户

## 工作流程

### 登录流程
1. 用户在登录页面输入邮箱和密码
2. 前端调用 `POST /api/auth/login`
3. 后端验证密码，生成 Access Token 和 Refresh Token
4. 前端保存 Token 到 localStorage
5. 自动跳转到首页

### 受保护页面访问流程
1. 用户访问受保护页面
2. `ProtectedRoute` 检查认证状态
3. 如果未登录，跳转到登录页
4. 如果已登录，渲染页面内容

### API 请求流程
1. API Client 自动从 localStorage 获取 Token
2. 添加 `Authorization: Bearer <token>` 头
3. 发送请求到后端 API
4. 如果收到 401 响应，自动跳转登录页

### 登出流程
1. 用户点击 TopNav 中的"退出登录"
2. 调用 `POST /api/auth/logout`
3. 清除 localStorage 中的 Token 和用户信息
4. 跳转到登录页

## 安全特性

✅ **密码加密**: 使用 bcrypt 进行密码哈希，10 轮加盐
✅ **JWT 签名**: 使用 HS256 算法签名 Token
✅ **Token 过期**: Access Token 7 天过期，Refresh Token 30 天过期
✅ **HTTPS 推荐**: 生产环境应使用 HTTPS 传输 Token
✅ **XSS 防护**: Token 存储在 localStorage（可考虑改用 httpOnly Cookie）
✅ **输入验证**: 所有 API 使用 Zod Schema 验证输入

## 使用指南

### 启动项目

```bash
# 1. 安装依赖
pnpm install

# 2. 运行数据库迁移和种子数据
pnpm db:migrate
pnpm db:seed

# 3. 启动开发服务器
pnpm dev

# 4. 访问登录页面
http://localhost:3000/login

# 5. 使用测试账号登录
邮箱: admin@example.com
密码: admin123
```

### 保护新页面

在 `app/(dashboard)/` 目录下创建的页面会自动受到保护。

### 在组件中使用认证

```typescript
import { useAuth } from '@/lib/auth-context'

function MyComponent() {
  const { user, logout, isAuthenticated } = useAuth()

  return (
    <div>
      <p>欢迎, {user?.name}</p>
      <button onClick={logout}>登出</button>
    </div>
  )
}
```

### 在 API 中验证用户

```typescript
import { authenticateRequest } from '@/lib/auth-middleware'

export async function GET(request: NextRequest) {
  const user = await authenticateRequest(request)
  if (!user) {
    return apiResponse.error('未授权', 'UNAUTHORIZED', 401)
  }

  // 使用 user.userId, user.email, user.role
}
```

## 未来改进建议

1. **Token 黑名单**: 实现 Redis Token 黑名单用于主动注销
2. **httpOnly Cookie**: 将 Token 存储从 localStorage 迁移到 httpOnly Cookie 提升安全性
3. **双因素认证**: 添加 2FA 支持
4. **密码重置**: 实现忘记密码功能
5. **Session 管理**: 允许用户查看和管理活跃会话
6. **IP 限制**: 添加异常登录检测和 IP 白名单
7. **审计日志**: 记录所有认证相关操作

## 测试建议

- ✅ 测试登录成功流程
- ✅ 测试登录失败（错误密码）
- ✅ 测试未登录访问受保护页面
- ✅ 测试登出功能
- ✅ 测试 Token 过期后自动跳转
- ✅ 测试刷新页面后会话保持

## 总结

本次实现完成了一个功能完整、安全可靠的 Token 鉴权系统，涵盖了前后端所有核心功能。系统采用现代化的设计模式，代码结构清晰，易于维护和扩展。UI 设计与原有系统保持一致，用户体验流畅。
